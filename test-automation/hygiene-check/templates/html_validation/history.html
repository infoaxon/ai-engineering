{% extends "base.html" %}
{% block title %}HTML Validation History - Hygiene Check{% endblock %}

{% block extra_css %}
<style>
    .score-badge-success { background-color: #198754; color: #fff; }
    .score-badge-warning { background-color: #ffc107; color: #212529; }
    .score-badge-danger  { background-color: #dc3545; color: #fff; }
    .score-badge-secondary { background-color: #6c757d; color: #fff; }

    .history-table th {
        white-space: nowrap;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        color: #6c757d;
    }
    .history-table td {
        vertical-align: middle;
    }
    .url-cell {
        max-width: 320px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .run-link:hover {
        text-decoration: underline !important;
    }
    .stat-chip {
        display: inline-block;
        min-width: 2rem;
        text-align: center;
        padding: 0.1rem 0.4rem;
        border-radius: 0.3rem;
        font-size: 0.8rem;
        font-weight: 600;
    }
    .stat-chip.errors {
        background-color: #f8d7da;
        color: #842029;
    }
    .stat-chip.warnings {
        background-color: #fff3cd;
        color: #664d03;
    }
    .stat-chip.zero {
        background-color: #d1e7dd;
        color: #0a3622;
    }
    .pagination-wrapper {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="row mb-4 align-items-center">
    <div class="col">
        <h4 class="mb-0">
            <i class="bi bi-clock-history me-2 text-primary"></i>HTML Validation History
        </h4>
        <p class="text-muted mb-0 mt-1 small">All past HTML validation runs &mdash; click a row to view full details.</p>
    </div>
    <div class="col-auto d-flex gap-2">
        <a href="/html-validation/" class="btn btn-primary btn-sm">
            <i class="bi bi-play-fill me-1"></i>New Validation
        </a>
        <a href="/dashboard" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-house me-1"></i>Dashboard
        </a>
    </div>
</div>

<!-- Stats Row -->
{% if runs %}
<div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
        <div class="card env-card text-center py-3 px-2">
            <div class="stat-number text-primary">{{ runs | length }}</div>
            <div class="stat-label">Total Runs</div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card env-card text-center py-3 px-2">
            {% set completed = runs | selectattr('status.value', 'equalto', 'completed') | list %}
            <div class="stat-number text-success">{{ completed | length }}</div>
            <div class="stat-label">Completed</div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card env-card text-center py-3 px-2">
            {% set failed = runs | selectattr('status.value', 'equalto', 'failed') | list %}
            <div class="stat-number text-danger">{{ failed | length }}</div>
            <div class="stat-label">Failed</div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card env-card text-center py-3 px-2">
            {% set scored = runs | selectattr('score', 'ne', none) | list %}
            {% if scored %}
            {% set avg_score = (scored | map(attribute='score') | sum) / scored | length %}
            <div class="stat-number {% if avg_score >= 80 %}text-success{% elif avg_score >= 60 %}text-warning{% else %}text-danger{% endif %}">
                {{ avg_score | round(1) }}
            </div>
            {% else %}
            <div class="stat-number text-muted">--</div>
            {% endif %}
            <div class="stat-label">Avg. Score</div>
        </div>
    </div>
</div>
{% endif %}

<!-- Filter / Search Bar -->
<div class="card env-card mb-3">
    <div class="card-body py-2 px-3">
        <div class="row g-2 align-items-center">
            <div class="col-md-5">
                <div class="input-group input-group-sm">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input
                        type="search"
                        class="form-control"
                        id="historySearch"
                        placeholder="Filter by URL, site, environment..."
                    >
                </div>
            </div>
            <div class="col-md-3">
                <select class="form-select form-select-sm" id="statusFilter">
                    <option value="">All Statuses</option>
                    <option value="completed">Completed</option>
                    <option value="failed">Failed</option>
                    <option value="running">Running</option>
                </select>
            </div>
            <div class="col-md-2">
                <select class="form-select form-select-sm" id="envFilter">
                    <option value="">All Environments</option>
                    <option value="dev">DEV</option>
                    <option value="sit">SIT</option>
                    <option value="uat">UAT</option>
                    <option value="prod">PROD</option>
                </select>
            </div>
            <div class="col-md-2 text-end">
                <span class="text-muted small" id="rowCount">
                    {% if runs %}{{ runs | length }} run{{ 's' if runs | length != 1 else '' }}{% else %}0 runs{% endif %}
                </span>
            </div>
        </div>
    </div>
</div>

<!-- History Table -->
<div class="card env-card">
    <div class="card-body p-0">
        {% if runs %}
        <div class="table-responsive">
            <table class="table table-hover history-table mb-0" id="historyTable">
                <thead class="table-light">
                    <tr>
                        <th class="ps-3" style="width: 3rem;">#</th>
                        <th>URL</th>
                        <th>Site</th>
                        <th>Env</th>
                        <th style="width: 6rem;">Score</th>
                        <th style="width: 5rem;">Errors</th>
                        <th style="width: 5.5rem;">Warnings</th>
                        <th style="width: 7rem;">Status</th>
                        <th style="width: 10rem;">Time</th>
                        <th style="width: 4rem;"></th>
                    </tr>
                </thead>
                <tbody id="historyTableBody">
                    {% for run in runs %}
                    <tr class="history-row"
                        data-status="{{ run.status.value }}"
                        data-env="{{ run.environment | lower }}"
                        data-text="{{ run.target_url }} {{ run.site_id }} {{ run.environment }}">
                        <!-- Run ID -->
                        <td class="ps-3 text-muted font-monospace small">{{ run.id }}</td>

                        <!-- URL -->
                        <td class="url-cell" title="{{ run.target_url }}">
                            <a href="/html-validation/?run_id={{ run.id }}"
                               class="text-decoration-none run-link fw-semibold text-dark">
                                {{ run.target_url | replace('https://', '') | replace('http://', '') }}
                            </a>
                        </td>

                        <!-- Site -->
                        <td>
                            <span class="badge bg-secondary" style="font-size: 0.7rem;">{{ run.site_id }}</span>
                        </td>

                        <!-- Environment -->
                        <td>
                            <span class="badge bg-dark" style="font-size: 0.7rem;">{{ run.environment | upper }}</span>
                        </td>

                        <!-- Score Badge -->
                        <td>
                            {% if run.score is not none %}
                            <span class="badge {% if run.score >= 80 %}score-badge-success{% elif run.score >= 60 %}score-badge-warning{% else %}score-badge-danger{% endif %}" style="font-size: 0.8rem; min-width: 3.5rem; text-align: center;">
                                {{ run.score | round(1) }}
                            </span>
                            {% else %}
                            <span class="badge score-badge-secondary" style="font-size: 0.8rem; min-width: 3.5rem; text-align: center;">--</span>
                            {% endif %}
                        </td>

                        <!-- Errors -->
                        <td>
                            {% if run.summary_json %}
                                {% set summary = run.summary_json | fromjson if run.summary_json is string else run.summary_json %}
                                {% set err = summary.get('error_count', '--') if summary else '--' %}
                            {% else %}
                                {% set err = '--' %}
                            {% endif %}
                            {% if err != '--' %}
                            <span class="stat-chip {% if err == 0 %}zero{% else %}errors{% endif %}">{{ err }}</span>
                            {% else %}
                            <span class="text-muted small">--</span>
                            {% endif %}
                        </td>

                        <!-- Warnings -->
                        <td>
                            {% if run.summary_json %}
                                {% set summary = run.summary_json | fromjson if run.summary_json is string else run.summary_json %}
                                {% set warn = summary.get('warning_count', '--') if summary else '--' %}
                            {% else %}
                                {% set warn = '--' %}
                            {% endif %}
                            {% if warn != '--' %}
                            <span class="stat-chip {% if warn == 0 %}zero{% else %}warnings{% endif %}">{{ warn }}</span>
                            {% else %}
                            <span class="text-muted small">--</span>
                            {% endif %}
                        </td>

                        <!-- Status -->
                        <td>
                            {% if run.status.value == 'completed' %}
                            <span class="badge bg-success">
                                <i class="bi bi-check-circle me-1"></i>Completed
                            </span>
                            {% elif run.status.value == 'running' %}
                            <span class="badge bg-warning text-dark">
                                <i class="bi bi-hourglass-split me-1"></i>Running
                            </span>
                            {% else %}
                            <span class="badge bg-danger">
                                <i class="bi bi-x-circle me-1"></i>Failed
                            </span>
                            {% endif %}
                        </td>

                        <!-- Time -->
                        <td class="small text-muted">
                            <span class="utc-time" data-utc="{{ run.started_at.isoformat() }}">
                                {{ run.started_at.strftime('%Y-%m-%d %H:%M') }}
                            </span>
                            {% if run.triggered_by %}
                            <div>
                                <span class="badge bg-light text-muted border" style="font-size: 0.65rem;">{{ run.triggered_by.value }}</span>
                            </div>
                            {% endif %}
                        </td>

                        <!-- View Link -->
                        <td class="text-end pe-3">
                            <a href="/html-validation/?run_id={{ run.id }}"
                               class="btn btn-outline-primary btn-sm py-0 px-2"
                               title="View details">
                                <i class="bi bi-arrow-right"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Empty filter result message -->
        <div id="noHistoryMsg" class="text-center text-muted py-5 d-none">
            <i class="bi bi-funnel" style="font-size: 2rem;"></i>
            <p class="mt-2 mb-0">No runs match your current filters.</p>
            <button class="btn btn-link btn-sm mt-1" onclick="clearFilters()">Clear filters</button>
        </div>

        {% else %}
        <!-- Empty state: no runs at all -->
        <div class="text-center py-5">
            <i class="bi bi-code-slash text-muted" style="font-size: 3rem;"></i>
            <h5 class="mt-3 text-muted">No Validation Runs Yet</h5>
            <p class="text-muted mb-3">HTML validation history will appear here after you run your first check.</p>
            <a href="/html-validation/" class="btn btn-primary">
                <i class="bi bi-play-fill me-1"></i>Run First Validation
            </a>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('historySearch');
    const statusFilter = document.getElementById('statusFilter');
    const envFilter = document.getElementById('envFilter');
    const rowCountEl = document.getElementById('rowCount');
    const noMsg = document.getElementById('noHistoryMsg');
    const tbody = document.getElementById('historyTableBody');

    function applyFilters() {
        if (!tbody) return;

        const search = searchInput ? searchInput.value.toLowerCase() : '';
        const status = statusFilter ? statusFilter.value.toLowerCase() : '';
        const env = envFilter ? envFilter.value.toLowerCase() : '';

        const rows = tbody.querySelectorAll('tr.history-row');
        let visible = 0;

        rows.forEach(row => {
            const rowStatus = (row.dataset.status || '').toLowerCase();
            const rowEnv = (row.dataset.env || '').toLowerCase();
            const rowText = (row.dataset.text || '').toLowerCase();

            const matchSearch = !search || rowText.includes(search);
            const matchStatus = !status || rowStatus === status;
            const matchEnv = !env || rowEnv === env;

            const show = matchSearch && matchStatus && matchEnv;
            row.style.display = show ? '' : 'none';
            if (show) visible++;
        });

        if (rowCountEl) {
            rowCountEl.textContent = `${visible} run${visible !== 1 ? 's' : ''}`;
        }
        if (noMsg) {
            noMsg.classList.toggle('d-none', visible > 0 || rows.length === 0);
        }
    }

    if (searchInput) searchInput.addEventListener('input', applyFilters);
    if (statusFilter) statusFilter.addEventListener('change', applyFilters);
    if (envFilter) envFilter.addEventListener('change', applyFilters);
});

function clearFilters() {
    const searchInput = document.getElementById('historySearch');
    const statusFilter = document.getElementById('statusFilter');
    const envFilter = document.getElementById('envFilter');
    if (searchInput) searchInput.value = '';
    if (statusFilter) statusFilter.value = '';
    if (envFilter) envFilter.value = '';

    // Re-trigger filter
    const tbody = document.getElementById('historyTableBody');
    if (tbody) {
        const rows = tbody.querySelectorAll('tr.history-row');
        rows.forEach(row => row.style.display = '');
        const rowCountEl = document.getElementById('rowCount');
        if (rowCountEl) rowCountEl.textContent = `${rows.length} run${rows.length !== 1 ? 's' : ''}`;
        const noMsg = document.getElementById('noHistoryMsg');
        if (noMsg) noMsg.classList.add('d-none');
    }
}
</script>
{% endblock %}
