{% extends "base.html" %}
{% block title %}HTML Validation - Hygiene Check{% endblock %}

{% block extra_css %}
<style>
    .severity-badge-error {
        background-color: #dc3545;
        color: #fff;
    }
    .severity-badge-warn {
        background-color: #ffc107;
        color: #212529;
    }
    .severity-badge-info {
        background-color: #0dcaf0;
        color: #212529;
    }
    .issue-row:hover {
        background-color: #f8f9fa;
    }
    .summary-stat {
        border-left: 4px solid;
        padding-left: 1rem;
    }
    .summary-stat.errors { border-color: #dc3545; }
    .summary-stat.warnings { border-color: #ffc107; }
    .summary-stat.score { border-color: #198754; }
    .sortable-header {
        cursor: pointer;
        user-select: none;
        white-space: nowrap;
    }
    .sortable-header:hover {
        background-color: #e9ecef;
    }
    .sort-icon {
        font-size: 0.75rem;
        color: #adb5bd;
        margin-left: 0.25rem;
    }
    .sort-icon.active {
        color: #212529;
    }
    .recent-run-item {
        border-left: 3px solid transparent;
        transition: border-color 0.2s, background-color 0.2s;
    }
    .recent-run-item:hover {
        border-left-color: #0d6efd;
        background-color: #f8f9fa;
    }
    .recent-run-item.active-run {
        border-left-color: #0d6efd;
        background-color: #e7f1ff;
    }
    .chart-container {
        position: relative;
        height: 240px;
    }
    .url-truncate {
        max-width: 260px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        display: inline-block;
        vertical-align: middle;
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="row mb-4 align-items-center">
    <div class="col">
        <h4 class="mb-0">
            <i class="bi bi-code-slash me-2 text-primary"></i>HTML Validation
        </h4>
        <p class="text-muted mb-0 mt-1 small">Validate HTML markup against W3C standards using html-validate.</p>
    </div>
    <div class="col-auto">
        <a href="/html-validation/history" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-clock-history me-1"></i>View History
        </a>
    </div>
</div>

<div class="row g-4">
    <!-- Main Content Column -->
    <div class="col-lg-9">

        <!-- Run Form Card -->
        <div class="card env-card mb-4">
            <div class="card-header bg-white border-bottom d-flex align-items-center">
                <i class="bi bi-play-circle me-2 text-primary"></i>
                <h6 class="mb-0">Run HTML Validation</h6>
            </div>
            <div class="card-body">
                <form id="htmlValidationForm" class="row g-3" onsubmit="return submitHtmlValidation(event)">
                    <!-- URL Input -->
                    <div class="col-12">
                        <label for="urlInput" class="form-label fw-semibold">Target URL</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-link-45deg"></i></span>
                            <input
                                type="url"
                                class="form-control"
                                id="urlInput"
                                name="url"
                                placeholder="https://example.com/page"
                                value="{{ run.target_url if run else '' }}"
                                required
                            >
                        </div>
                    </div>

                    <!-- Site + Environment Selectors -->
                    <div class="col-md-5">
                        <label for="siteSelect" class="form-label fw-semibold">Site</label>
                        <select class="form-select" id="siteSelect" name="site_id">
                            <option value="default">-- Ad-hoc --</option>
                            {% for site in sites %}
                            <option value="{{ site.site_id }}" {% if run and run.site_id == site.site_id %}selected{% endif %}>
                                {{ site.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label for="envSelect" class="form-label fw-semibold">Environment</label>
                        <select class="form-select" id="envSelect" name="environment">
                            <option value="production">-- Production --</option>
                            <option value="dev" {% if run and run.environment == 'dev' %}selected{% endif %}>DEV</option>
                            <option value="sit" {% if run and run.environment == 'sit' %}selected{% endif %}>SIT</option>
                            <option value="uat" {% if run and run.environment == 'uat' %}selected{% endif %}>UAT</option>
                            <option value="prod" {% if run and run.environment == 'prod' %}selected{% endif %}>PROD</option>
                        </select>
                    </div>

                    <div class="col-md-3 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100" id="submitBtn">
                            <i class="bi bi-play-fill me-1"></i>Validate
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Live Log Console (hidden until a check is running) -->
        <div id="liveLogConsole"></div>

        {% if run %}
        <!-- Summary Card -->
        <div class="card env-card mb-4">
            <div class="card-header bg-white border-bottom d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <i class="bi bi-clipboard-data me-2 text-primary"></i>
                    <h6 class="mb-0">Validation Summary</h6>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <span class="badge bg-secondary">Run #{{ run.id }}</span>
                    {% if run.status.value == 'completed' %}
                    <span class="badge bg-success">
                        <i class="bi bi-check-circle me-1"></i>Completed
                    </span>
                    {% elif run.status.value == 'running' %}
                    <span class="badge bg-warning text-dark">
                        <i class="bi bi-hourglass-split me-1"></i>Running
                    </span>
                    {% else %}
                    <span class="badge bg-danger">
                        <i class="bi bi-x-circle me-1"></i>Failed
                    </span>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                <div class="row g-4 align-items-center">
                    <!-- Score -->
                    <div class="col-auto">
                        <div class="summary-stat score">
                            <div class="stat-number {% if run.score is not none and run.score >= 80 %}text-success{% elif run.score is not none and run.score >= 60 %}text-warning{% elif run.score is not none %}text-danger{% else %}text-muted{% endif %}">
                                {% if run.score is not none %}{{ run.score | round(1) }}{% else %}--{% endif %}
                            </div>
                            <div class="stat-label">Score</div>
                        </div>
                    </div>

                    <!-- Errors -->
                    <div class="col-auto">
                        <div class="summary-stat errors">
                            <div class="stat-number text-danger">{{ error_count }}</div>
                            <div class="stat-label">Errors</div>
                        </div>
                    </div>

                    <!-- Warnings -->
                    <div class="col-auto">
                        <div class="summary-stat warnings">
                            <div class="stat-number text-warning">{{ warning_count }}</div>
                            <div class="stat-label">Warnings</div>
                        </div>
                    </div>

                    <!-- Total Issues -->
                    <div class="col-auto">
                        <div class="summary-stat" style="border-color: #6c757d;">
                            <div class="stat-number text-muted">{{ issues | length }}</div>
                            <div class="stat-label">Total Issues</div>
                        </div>
                    </div>

                    <!-- URL + Time info -->
                    <div class="col ms-2">
                        <div class="text-muted small mb-1">
                            <i class="bi bi-link-45deg me-1"></i>
                            <a href="{{ run.target_url }}" target="_blank" class="text-decoration-none text-truncate d-inline-block" style="max-width: 400px; vertical-align: middle;">
                                {{ run.target_url }}
                            </a>
                        </div>
                        <div class="text-muted small mb-1">
                            <i class="bi bi-tag me-1"></i>
                            <span class="badge bg-dark">{{ run.environment | upper }}</span>
                            <span class="badge bg-secondary ms-1">{{ run.site_id }}</span>
                        </div>
                        <div class="text-muted small">
                            <i class="bi bi-clock me-1"></i>
                            <span class="utc-time" data-utc="{{ run.started_at.isoformat() }}">{{ run.started_at.strftime('%Y-%m-%d %H:%M') }}</span>
                            {% if run.completed_at %}
                            &mdash;
                            <span class="utc-time" data-utc="{{ run.completed_at.isoformat() }}">{{ run.completed_at.strftime('%Y-%m-%d %H:%M') }}</span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                {% if run.error_message %}
                <div class="alert alert-danger mt-3 mb-0 py-2">
                    <i class="bi bi-exclamation-triangle me-2"></i>{{ run.error_message }}
                </div>
                {% endif %}
            </div>
        </div>

        {% if issues %}
        <!-- Rule Distribution Chart -->
        <div class="card env-card mb-4">
            <div class="card-header bg-white border-bottom">
                <h6 class="mb-0"><i class="bi bi-bar-chart me-2 text-primary"></i>Rule Distribution</h6>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="ruleDistributionChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Issues Table -->
        <div class="card env-card">
            <div class="card-header bg-white border-bottom d-flex align-items-center justify-content-between">
                <h6 class="mb-0">
                    <i class="bi bi-list-ul me-2 text-primary"></i>Issues
                    <span class="badge bg-secondary ms-1">{{ issues | length }}</span>
                </h6>
                <div class="d-flex gap-2 align-items-center">
                    <!-- Filter by severity -->
                    <select class="form-select form-select-sm" id="severityFilter" style="width: auto;">
                        <option value="">All Severities</option>
                        <option value="error">Errors only</option>
                        <option value="warn">Warnings only</option>
                        <option value="info">Info only</option>
                    </select>
                    <input
                        type="search"
                        class="form-control form-control-sm"
                        id="issueSearch"
                        placeholder="Search issues..."
                        style="width: 200px;"
                    >
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0" id="issuesTable">
                        <thead class="table-light">
                            <tr>
                                <th class="sortable-header ps-3" data-col="line">
                                    Line <i class="bi bi-arrow-down-up sort-icon" id="sort-line"></i>
                                </th>
                                <th class="sortable-header" data-col="column">
                                    Col <i class="bi bi-arrow-down-up sort-icon" id="sort-column"></i>
                                </th>
                                <th class="sortable-header" data-col="severity">
                                    Severity <i class="bi bi-arrow-down-up sort-icon" id="sort-severity"></i>
                                </th>
                                <th>Message</th>
                                <th class="sortable-header" data-col="rule">
                                    Rule <i class="bi bi-arrow-down-up sort-icon" id="sort-rule"></i>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="issuesTableBody">
                            {% for issue in issues %}
                            <tr class="issue-row"
                                data-line="{{ issue.line_number or 0 }}"
                                data-column="{{ issue.column_number or 0 }}"
                                data-severity="{{ issue.severity.value }}"
                                data-rule="{{ issue.rule }}">
                                <td class="ps-3 text-muted font-monospace small">
                                    {{ issue.line_number if issue.line_number else '--' }}
                                </td>
                                <td class="text-muted font-monospace small">
                                    {{ issue.column_number if issue.column_number else '--' }}
                                </td>
                                <td>
                                    {% if issue.severity.value == 'error' %}
                                    <span class="badge severity-badge-error">
                                        <i class="bi bi-x-circle me-1"></i>error
                                    </span>
                                    {% elif issue.severity.value == 'warn' %}
                                    <span class="badge severity-badge-warn">
                                        <i class="bi bi-exclamation-triangle me-1"></i>warn
                                    </span>
                                    {% else %}
                                    <span class="badge severity-badge-info">
                                        <i class="bi bi-info-circle me-1"></i>info
                                    </span>
                                    {% endif %}
                                </td>
                                <td class="small">{{ issue.message }}</td>
                                <td>
                                    <code class="small text-primary">{{ issue.rule }}</code>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div id="noIssuesMsg" class="text-center text-muted py-4 d-none">
                    No issues match your filters.
                </div>
            </div>
        </div>

        {% else %}
        <!-- No issues -->
        <div class="card env-card">
            <div class="card-body text-center py-5">
                <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
                <h5 class="mt-3 text-success">No Issues Found</h5>
                <p class="text-muted">The page passed HTML validation with no errors or warnings.</p>
            </div>
        </div>
        {% endif %}

        {% endif %}{# end if run #}

        {% if not run %}
        <!-- Empty state -->
        <div class="card env-card">
            <div class="card-body text-center py-5">
                <i class="bi bi-code-slash text-muted" style="font-size: 3rem;"></i>
                <h5 class="mt-3 text-muted">No Validation Run Selected</h5>
                <p class="text-muted mb-0">Enter a URL above and click <strong>Validate</strong> to start a new run,<br>or select a recent run from the sidebar.</p>
            </div>
        </div>
        {% endif %}

    </div><!-- /col-lg-9 -->

    <!-- Sidebar: Recent Runs -->
    <div class="col-lg-3">
        <div class="card env-card">
            <div class="card-header bg-white border-bottom d-flex align-items-center justify-content-between">
                <h6 class="mb-0">
                    <i class="bi bi-clock-history me-2 text-primary"></i>Recent Runs
                </h6>
                <a href="/html-validation/history" class="btn btn-outline-secondary btn-sm py-0 px-2">
                    All
                </a>
            </div>
            <div class="list-group list-group-flush">
                {% for r in recent_runs %}
                <a href="/html-validation/?run_id={{ r.id }}"
                   class="list-group-item list-group-item-action recent-run-item px-3 py-2 {% if run and run.id == r.id %}active-run{% endif %}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1 me-2" style="min-width: 0;">
                            <div class="small fw-semibold text-truncate" title="{{ r.target_url }}">
                                {{ r.target_url | replace('https://', '') | replace('http://', '') }}
                            </div>
                            <div class="d-flex align-items-center gap-1 mt-1 flex-wrap">
                                <span class="badge bg-dark" style="font-size: 0.65rem;">{{ r.environment | upper }}</span>
                                {% if r.status.value == 'completed' %}
                                <span class="status-indicator healthy" style="width: 8px; height: 8px;"></span>
                                {% elif r.status.value == 'running' %}
                                <span class="status-indicator degraded" style="width: 8px; height: 8px;"></span>
                                {% else %}
                                <span class="status-indicator unhealthy" style="width: 8px; height: 8px;"></span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="text-end flex-shrink-0">
                            {% if r.score is not none %}
                            <span class="badge {% if r.score >= 80 %}bg-success{% elif r.score >= 60 %}bg-warning text-dark{% else %}bg-danger{% endif %}" style="font-size: 0.7rem;">
                                {{ r.score | round(0) | int }}
                            </span>
                            {% else %}
                            <span class="badge bg-secondary" style="font-size: 0.7rem;">--</span>
                            {% endif %}
                            <div class="text-muted mt-1" style="font-size: 0.65rem;">
                                <span class="utc-time" data-utc="{{ r.started_at.isoformat() }}">{{ r.started_at.strftime('%m/%d %H:%M') }}</span>
                            </div>
                        </div>
                    </div>
                </a>
                {% else %}
                <div class="list-group-item text-muted text-center py-4 small">
                    No recent runs yet.
                </div>
                {% endfor %}
            </div>
        </div>
    </div><!-- /col-lg-3 -->

</div><!-- /row -->
{% endblock %}

{% block extra_js %}
<script>
function submitHtmlValidation(e) {
    e.preventDefault();
    const url = document.getElementById('urlInput').value;
    const siteId = document.getElementById('siteSelect').value;
    const env = document.getElementById('envSelect').value;
    const btn = document.getElementById('submitBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Starting...';
    runCheckWithLiveLog({
        apiUrl: '/api/html-validation/run',
        payload: { url: url, site_id: siteId, environment: env },
        containerId: 'liveLogConsole',
        redirectBase: '/html-validation/',
    });
    return false;
}

document.addEventListener('DOMContentLoaded', () => {

    // -------------------------
    // Rule Distribution Chart
    // -------------------------
    {% if run and rule_counts %}
    const ruleLabels = {{ rule_counts.keys() | list | tojson }};
    const ruleCounts = {{ rule_counts.values() | list | tojson }};

    const ruleCtx = document.getElementById('ruleDistributionChart');
    if (ruleCtx) {
        const palette = [
            '#dc3545', '#ffc107', '#0d6efd', '#198754',
            '#6f42c1', '#fd7e14', '#20c997', '#0dcaf0',
            '#d63384', '#6c757d'
        ];
        new Chart(ruleCtx, {
            type: 'bar',
            data: {
                labels: ruleLabels,
                datasets: [{
                    label: 'Issue Count',
                    data: ruleCounts,
                    backgroundColor: ruleLabels.map((_, i) => palette[i % palette.length]),
                    borderWidth: 0,
                    borderRadius: 4,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: ctx => ` ${ctx.parsed.y} issue${ctx.parsed.y !== 1 ? 's' : ''}`
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            maxRotation: 30,
                            font: { size: 11 }
                        },
                        grid: { display: false }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0,
                            font: { size: 11 }
                        }
                    }
                }
            }
        });
    }
    {% endif %}

    // -------------------------
    // Issues Table: Sort
    // -------------------------
    const table = document.getElementById('issuesTable');
    if (!table) return;

    let sortCol = null;
    let sortDir = 1; // 1 = asc, -1 = desc

    document.querySelectorAll('.sortable-header').forEach(th => {
        th.addEventListener('click', () => {
            const col = th.dataset.col;
            if (sortCol === col) {
                sortDir *= -1;
            } else {
                sortCol = col;
                sortDir = 1;
            }

            // Update sort icons
            document.querySelectorAll('.sort-icon').forEach(icon => icon.classList.remove('active'));
            const activeIcon = document.getElementById(`sort-${col}`);
            if (activeIcon) {
                activeIcon.classList.add('active');
                activeIcon.className = activeIcon.className.replace(/bi-arrow-\S+/, '');
                activeIcon.classList.add(sortDir === 1 ? 'bi-arrow-up' : 'bi-arrow-down');
            }

            sortTable(col, sortDir);
        });
    });

    function sortTable(col, dir) {
        const tbody = document.getElementById('issuesTableBody');
        const rows = Array.from(tbody.querySelectorAll('tr.issue-row'));
        rows.sort((a, b) => {
            let aVal = a.dataset[col] || '';
            let bVal = b.dataset[col] || '';
            const aNum = parseFloat(aVal);
            const bNum = parseFloat(bVal);
            if (!isNaN(aNum) && !isNaN(bNum)) {
                return (aNum - bNum) * dir;
            }
            return aVal.localeCompare(bVal) * dir;
        });
        rows.forEach(row => tbody.appendChild(row));
        applyFilters();
    }

    // -------------------------
    // Issues Table: Filter
    // -------------------------
    const severityFilter = document.getElementById('severityFilter');
    const searchInput = document.getElementById('issueSearch');

    function applyFilters() {
        const sevVal = severityFilter ? severityFilter.value.toLowerCase() : '';
        const searchVal = searchInput ? searchInput.value.toLowerCase() : '';
        const tbody = document.getElementById('issuesTableBody');
        const rows = tbody ? tbody.querySelectorAll('tr.issue-row') : [];
        let visible = 0;

        rows.forEach(row => {
            const sev = (row.dataset.severity || '').toLowerCase();
            const text = row.textContent.toLowerCase();
            const sevMatch = !sevVal || sev === sevVal;
            const searchMatch = !searchVal || text.includes(searchVal);
            const show = sevMatch && searchMatch;
            row.style.display = show ? '' : 'none';
            if (show) visible++;
        });

        const noMsg = document.getElementById('noIssuesMsg');
        if (noMsg) noMsg.classList.toggle('d-none', visible > 0);
    }

    if (severityFilter) severityFilter.addEventListener('change', applyFilters);
    if (searchInput) searchInput.addEventListener('input', applyFilters);

});
</script>
{% endblock %}
