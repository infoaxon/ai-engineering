{% extends "base.html" %}
{% block title %}SEO Audit - Hygiene Check{% endblock %}

{% block extra_css %}
<style>
    /* ---- Status badge overrides ---- */
    .seo-badge-pass {
        background-color: #198754;
        color: #fff;
    }
    .seo-badge-fail {
        background-color: #dc3545;
        color: #fff;
    }
    .seo-badge-warn {
        background-color: #ffc107;
        color: #212529;
    }
    .seo-badge-info {
        background-color: #6c757d;
        color: #fff;
    }

    /* ---- Accordion section header pill counts ---- */
    .section-counts {
        font-size: 0.7rem;
        gap: 0.25rem;
    }

    /* ---- Item rows inside accordion ---- */
    .seo-item-row {
        border-left: 3px solid transparent;
        transition: background-color 0.15s;
    }
    .seo-item-row.status-pass  { border-left-color: #198754; }
    .seo-item-row.status-fail  { border-left-color: #dc3545; }
    .seo-item-row.status-warn  { border-left-color: #ffc107; }
    .seo-item-row.status-info  { border-left-color: #6c757d; }
    .seo-item-row:hover        { background-color: #f8f9fa; }

    /* ---- Score gauge label sizing ---- */
    .score-label-seo {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 1.75rem;
        font-weight: 700;
        line-height: 1;
        pointer-events: none;
    }

    /* ---- Grade pill ---- */
    .grade-pill {
        font-size: 1rem;
        font-weight: 700;
        padding: 0.35em 0.9em;
        border-radius: 2rem;
        letter-spacing: 0.05em;
    }

    /* ---- Recent run sidebar ---- */
    .recent-run-item {
        border-left: 3px solid transparent;
        transition: border-color 0.2s, background-color 0.2s;
    }
    .recent-run-item:hover        { border-left-color: #0d6efd; background-color: #f8f9fa; }
    .recent-run-item.active-run   { border-left-color: #0d6efd; background-color: #e7f1ff; }

    /* ---- Remote toggle ---- */
    .form-check-input:checked { background-color: #212529; border-color: #212529; }

    /* ---- Details text ---- */
    .item-details {
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: 0.15rem;
    }

    /* ---- Accordion section summary bar ---- */
    .section-progress {
        height: 4px;
        border-radius: 2px;
        overflow: hidden;
        background-color: #e9ecef;
        margin-top: 0.5rem;
    }
    .section-progress .bar-pass { background-color: #198754; }
    .section-progress .bar-warn { background-color: #ffc107; }
    .section-progress .bar-fail { background-color: #dc3545; }
</style>
{% endblock %}

{% block content %}
<!-- ===== Page Header ===== -->
<div class="row mb-4 align-items-center">
    <div class="col">
        <h4 class="mb-0">
            <i class="bi bi-search me-2 text-primary"></i>SEO Audit
        </h4>
        <p class="text-muted mb-0 mt-1 small">
            Run a comprehensive 12-section SEO hygiene check against any URL.
        </p>
    </div>
    <div class="col-auto">
        <a href="/seo-audit/compare" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-columns-gap me-1"></i>Compare Environments
        </a>
    </div>
</div>

<div class="row g-4">
    <!-- ===== Main Content ===== -->
    <div class="col-lg-9">

        <!-- Run Form Card -->
        <div class="card env-card mb-4">
            <div class="card-header bg-white border-bottom d-flex align-items-center">
                <i class="bi bi-play-circle me-2 text-primary"></i>
                <h6 class="mb-0">Run SEO Audit</h6>
            </div>
            <div class="card-body">
                <form id="seoAuditForm" class="row g-3" onsubmit="return submitSeoAudit(event)">

                    <!-- URL -->
                    <div class="col-12">
                        <label for="urlInput" class="form-label fw-semibold">Target URL</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-link-45deg"></i></span>
                            <input
                                type="url"
                                class="form-control"
                                id="urlInput"
                                name="url"
                                placeholder="https://example.com/page"
                                value="{{ run.target_url if run else '' }}"
                                required
                            >
                        </div>
                    </div>

                    <!-- Site selector -->
                    <div class="col-md-4">
                        <label for="siteSelect" class="form-label fw-semibold">Site</label>
                        <select class="form-select" id="siteSelect" name="site_id">
                            <option value="default">-- Ad-hoc --</option>
                            {% for site in sites %}
                            <option value="{{ site.site_id }}" {% if run and run.site_id == site.site_id %}selected{% endif %}>
                                {{ site.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Environment selector -->
                    <div class="col-md-3">
                        <label for="envSelect" class="form-label fw-semibold">Environment</label>
                        <select class="form-select" id="envSelect" name="environment">
                            <option value="production">-- Production --</option>
                            <option value="dev"  {% if run and run.environment == 'dev'  %}selected{% endif %}>DEV</option>
                            <option value="sit"  {% if run and run.environment == 'sit'  %}selected{% endif %}>SIT</option>
                            <option value="uat"  {% if run and run.environment == 'uat'  %}selected{% endif %}>UAT</option>
                            <option value="prod" {% if run and run.environment == 'prod' %}selected{% endif %}>PROD</option>
                        </select>
                    </div>

                    <!-- Remote / Local toggle -->
                    <div class="col-md-2 d-flex flex-column justify-content-end">
                        <label class="form-label fw-semibold">Mode</label>
                        <div class="form-check form-switch mt-1">
                            <input
                                class="form-check-input"
                                type="checkbox"
                                id="remoteToggle"
                                name="remote"
                                value="true"
                                {% if not run or run is none %}checked{% elif run and request.method == 'GET' %}checked{% endif %}
                            >
                            <label class="form-check-label small" for="remoteToggle">Remote fetch</label>
                        </div>
                    </div>

                    <!-- Submit -->
                    <div class="col-md-3 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100" id="seoSubmitBtn">
                            <i class="bi bi-play-fill me-1"></i>Audit
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Live Log Console (hidden until a check is running) -->
        <div id="liveLogConsole"></div>

        {% if run %}
        <!-- ===== Summary Card ===== -->
        <div class="card env-card mb-4">
            <div class="card-header bg-white border-bottom d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <i class="bi bi-clipboard-data me-2 text-primary"></i>
                    <h6 class="mb-0">Audit Summary</h6>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <span class="badge bg-secondary">Run #{{ run.id }}</span>
                    {% if run.status.value == 'completed' %}
                    <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Completed</span>
                    {% elif run.status.value == 'running' %}
                    <span class="badge bg-warning text-dark"><i class="bi bi-hourglass-split me-1"></i>Running</span>
                    {% else %}
                    <span class="badge bg-danger"><i class="bi bi-x-circle me-1"></i>Failed</span>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                <div class="row g-3 align-items-center">

                    <!-- Score gauge -->
                    <div class="col-auto">
                        <div class="score-gauge" style="width:150px;height:150px;position:relative;">
                            <canvas id="seoScoreGauge" width="150" height="150"></canvas>
                            <div class="score-label-seo
                                {% if summary.overall_score is not none and summary.overall_score >= 80 %}text-success
                                {% elif summary.overall_score is not none and summary.overall_score >= 60 %}text-warning
                                {% elif summary.overall_score is not none %}text-danger
                                {% else %}text-muted{% endif %}">
                                {% if summary.overall_score is not none %}{{ summary.overall_score | int }}{% else %}--{% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Grade + stat chips -->
                    <div class="col">
                        <div class="mb-2">
                            {% set grade = summary.get('grade', '') if summary else '' %}
                            <span class="grade-pill
                                {% if summary.overall_score is not none and summary.overall_score >= 80 %}bg-success text-white
                                {% elif summary.overall_score is not none and summary.overall_score >= 60 %}bg-warning text-dark
                                {% elif summary.overall_score is not none %}bg-danger text-white
                                {% else %}bg-secondary text-white{% endif %}">
                                {{ summary.get('grade', 'N/A') if summary else 'N/A' }}
                            </span>
                        </div>
                        <div class="d-flex flex-wrap gap-3 mt-2">
                            <div class="summary-stat" style="border-left: 4px solid #198754; padding-left: 0.75rem;">
                                <div class="stat-number text-success">{{ summary.get('pass_count', 0) if summary else 0 }}</div>
                                <div class="stat-label">Passed</div>
                            </div>
                            <div class="summary-stat" style="border-left: 4px solid #dc3545; padding-left: 0.75rem;">
                                <div class="stat-number text-danger">{{ summary.get('fail_count', 0) if summary else 0 }}</div>
                                <div class="stat-label">Failed</div>
                            </div>
                            <div class="summary-stat" style="border-left: 4px solid #ffc107; padding-left: 0.75rem;">
                                <div class="stat-number text-warning">{{ summary.get('warn_count', 0) if summary else 0 }}</div>
                                <div class="stat-label">Warnings</div>
                            </div>
                            <div class="summary-stat" style="border-left: 4px solid #6c757d; padding-left: 0.75rem;">
                                <div class="stat-number text-muted">{{ summary.get('total_checks', 0) if summary else 0 }}</div>
                                <div class="stat-label">Total Checks</div>
                            </div>
                        </div>
                    </div>

                    <!-- Meta info -->
                    <div class="col-12 col-md-auto ms-md-auto">
                        <div class="text-muted small mb-1">
                            <i class="bi bi-link-45deg me-1"></i>
                            <a href="{{ run.target_url }}" target="_blank" class="text-decoration-none text-truncate d-inline-block" style="max-width:360px;vertical-align:middle;">
                                {{ run.target_url }}
                            </a>
                        </div>
                        <div class="text-muted small mb-1">
                            <i class="bi bi-tag me-1"></i>
                            <span class="badge bg-dark">{{ run.environment | upper }}</span>
                            <span class="badge bg-secondary ms-1">{{ run.site_id }}</span>
                        </div>
                        <div class="text-muted small">
                            <i class="bi bi-clock me-1"></i>
                            <span class="utc-time" data-utc="{{ run.started_at.isoformat() }}">{{ run.started_at.strftime('%Y-%m-%d %H:%M') }}</span>
                            {% if run.completed_at %}
                            &mdash;
                            <span class="utc-time" data-utc="{{ run.completed_at.isoformat() }}">{{ run.completed_at.strftime('%Y-%m-%d %H:%M') }}</span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                {% if run.error_message %}
                <div class="alert alert-danger mt-3 mb-0 py-2">
                    <i class="bi bi-exclamation-triangle me-2"></i>{{ run.error_message }}
                </div>
                {% endif %}
            </div>
        </div>

        {% if sections %}
        <!-- ===== Accordion: 12 Sections ===== -->
        <div class="card env-card mb-4">
            <div class="card-header bg-white border-bottom d-flex align-items-center justify-content-between">
                <h6 class="mb-0"><i class="bi bi-list-check me-2 text-primary"></i>Audit Sections</h6>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary btn-sm py-0 px-2" id="expandAllBtn" title="Expand all sections">
                        <i class="bi bi-arrows-expand me-1"></i>Expand All
                    </button>
                    <button class="btn btn-outline-secondary btn-sm py-0 px-2" id="collapseAllBtn" title="Collapse all sections">
                        <i class="bi bi-arrows-collapse me-1"></i>Collapse All
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="accordion accordion-flush" id="seoAccordion">
                    {% for (sec_num, sec_name), items in sections | dictsort(by='key') %}
                    {% set sec_pass = items | selectattr('status.value', 'equalto', 'pass') | list | length %}
                    {% set sec_fail = items | selectattr('status.value', 'equalto', 'fail') | list | length %}
                    {% set sec_warn = items | selectattr('status.value', 'equalto', 'warn') | list | length %}
                    {% set sec_info = items | selectattr('status.value', 'equalto', 'info') | list | length %}
                    {% set sec_total = items | length %}

                    <div class="accordion-item border-0 border-bottom">
                        <h2 class="accordion-header" id="heading-sec{{ sec_num }}">
                            <button
                                class="accordion-button {% if sec_fail == 0 %}collapsed{% endif %} py-3"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#collapse-sec{{ sec_num }}"
                                aria-expanded="{{ 'true' if sec_fail > 0 else 'false' }}"
                                aria-controls="collapse-sec{{ sec_num }}"
                            >
                                <!-- Section number badge -->
                                <span class="badge bg-secondary me-2" style="min-width:1.8rem;font-size:0.75rem;">{{ sec_num }}</span>

                                <!-- Section name -->
                                <span class="fw-semibold me-3">{{ sec_name }}</span>

                                <!-- Per-section status counts -->
                                <span class="d-flex section-counts ms-auto me-3">
                                    {% if sec_pass > 0 %}
                                    <span class="badge seo-badge-pass">
                                        <i class="bi bi-check-circle me-1"></i>{{ sec_pass }}
                                    </span>
                                    {% endif %}
                                    {% if sec_fail > 0 %}
                                    <span class="badge seo-badge-fail">
                                        <i class="bi bi-x-circle me-1"></i>{{ sec_fail }}
                                    </span>
                                    {% endif %}
                                    {% if sec_warn > 0 %}
                                    <span class="badge seo-badge-warn">
                                        <i class="bi bi-exclamation-triangle me-1"></i>{{ sec_warn }}
                                    </span>
                                    {% endif %}
                                    {% if sec_info > 0 %}
                                    <span class="badge seo-badge-info">
                                        <i class="bi bi-info-circle me-1"></i>{{ sec_info }}
                                    </span>
                                    {% endif %}
                                </span>
                            </button>
                        </h2>

                        <div
                            id="collapse-sec{{ sec_num }}"
                            class="accordion-collapse collapse {% if sec_fail > 0 %}show{% endif %}"
                            aria-labelledby="heading-sec{{ sec_num }}"
                            data-bs-parent=""
                        >
                            <div class="accordion-body p-0">
                                <!-- Mini progress bar -->
                                {% if sec_total > 0 %}
                                <div class="section-progress mx-3 mt-2">
                                    <div class="d-flex h-100">
                                        <div class="bar-pass" style="width:{{ (sec_pass / sec_total * 100) | round(1) }}%;" title="{{ sec_pass }} pass"></div>
                                        <div class="bar-warn" style="width:{{ (sec_warn / sec_total * 100) | round(1) }}%;" title="{{ sec_warn }} warn"></div>
                                        <div class="bar-fail" style="width:{{ (sec_fail / sec_total * 100) | round(1) }}%;" title="{{ sec_fail }} fail"></div>
                                    </div>
                                </div>
                                {% endif %}

                                <ul class="list-unstyled mb-0">
                                    {% for item in items %}
                                    <li class="seo-item-row status-{{ item.status.value }} px-3 py-2 d-flex align-items-start gap-2">
                                        <!-- Status badge -->
                                        <div class="flex-shrink-0 mt-1">
                                            {% if item.status.value == 'pass' %}
                                            <span class="badge seo-badge-pass"><i class="bi bi-check-circle me-1"></i>PASS</span>
                                            {% elif item.status.value == 'fail' %}
                                            <span class="badge seo-badge-fail"><i class="bi bi-x-circle me-1"></i>FAIL</span>
                                            {% elif item.status.value == 'warn' %}
                                            <span class="badge seo-badge-warn"><i class="bi bi-exclamation-triangle me-1"></i>WARN</span>
                                            {% else %}
                                            <span class="badge seo-badge-info"><i class="bi bi-info-circle me-1"></i>INFO</span>
                                            {% endif %}
                                        </div>

                                        <!-- Message + details -->
                                        <div class="flex-grow-1">
                                            <div class="small fw-semibold">{{ item.message }}</div>
                                            {% if item.details %}
                                            <div class="item-details font-monospace">{{ item.details }}</div>
                                            {% endif %}
                                        </div>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        {% else %}
        <!-- No items after a run -->
        <div class="card env-card mb-4">
            <div class="card-body text-center py-5">
                <i class="bi bi-clipboard-x text-muted" style="font-size:3rem;"></i>
                <h5 class="mt-3 text-muted">No Audit Items Found</h5>
                <p class="text-muted mb-0">The audit completed but produced no check items. Check the target URL is accessible.</p>
            </div>
        </div>
        {% endif %}

        {% else %}
        <!-- Empty state: no run yet -->
        <div class="card env-card">
            <div class="card-body text-center py-5">
                <i class="bi bi-search text-muted" style="font-size:3rem;"></i>
                <h5 class="mt-3 text-muted">No Audit Run Selected</h5>
                <p class="text-muted mb-0">
                    Enter a URL above and click <strong>Audit</strong> to start a new run,<br>
                    or select a recent run from the sidebar.
                </p>
            </div>
        </div>
        {% endif %}

    </div><!-- /col-lg-9 -->

    <!-- ===== Sidebar: Recent Runs ===== -->
    <div class="col-lg-3">
        <div class="card env-card">
            <div class="card-header bg-white border-bottom d-flex align-items-center justify-content-between">
                <h6 class="mb-0">
                    <i class="bi bi-clock-history me-2 text-primary"></i>Recent Runs
                </h6>
            </div>
            <div class="list-group list-group-flush">
                {% for r in recent_runs %}
                <a href="/seo-audit/?run_id={{ r.id }}"
                   class="list-group-item list-group-item-action recent-run-item px-3 py-2 {% if run and run.id == r.id %}active-run{% endif %}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1 me-2" style="min-width:0;">
                            <div class="small fw-semibold text-truncate" title="{{ r.target_url }}">
                                {{ r.target_url | replace('https://', '') | replace('http://', '') }}
                            </div>
                            <div class="d-flex align-items-center gap-1 mt-1 flex-wrap">
                                <span class="badge bg-dark" style="font-size:0.65rem;">{{ r.environment | upper }}</span>
                                {% if r.status.value == 'completed' %}
                                <span class="status-indicator healthy" style="width:8px;height:8px;"></span>
                                {% elif r.status.value == 'running' %}
                                <span class="status-indicator degraded" style="width:8px;height:8px;"></span>
                                {% else %}
                                <span class="status-indicator unhealthy" style="width:8px;height:8px;"></span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="text-end flex-shrink-0">
                            {% if r.score is not none %}
                            <span class="badge {% if r.score >= 80 %}bg-success{% elif r.score >= 60 %}bg-warning text-dark{% else %}bg-danger{% endif %}" style="font-size:0.7rem;">
                                {{ r.score | round(0) | int }}
                            </span>
                            {% else %}
                            <span class="badge bg-secondary" style="font-size:0.7rem;">--</span>
                            {% endif %}
                            <div class="text-muted mt-1" style="font-size:0.65rem;">
                                <span class="utc-time" data-utc="{{ r.started_at.isoformat() }}">{{ r.started_at.strftime('%m/%d %H:%M') }}</span>
                            </div>
                        </div>
                    </div>
                </a>
                {% else %}
                <div class="list-group-item text-muted text-center py-4 small">
                    No recent runs yet.
                </div>
                {% endfor %}
            </div>
        </div>
    </div><!-- /col-lg-3 -->

</div><!-- /row -->
{% endblock %}

{% block extra_js %}
<script>
function submitSeoAudit(e) {
    e.preventDefault();
    const url = document.getElementById('urlInput').value;
    const siteId = document.getElementById('siteSelect').value;
    const env = document.getElementById('envSelect').value;
    const btn = document.getElementById('seoSubmitBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Starting...';
    runCheckWithLiveLog({
        apiUrl: '/api/seo-audit/run',
        payload: { url: url, site_id: siteId, environment: env },
        containerId: 'liveLogConsole',
        redirectBase: '/seo-audit/',
    });
    return false;
}

document.addEventListener('DOMContentLoaded', () => {

    // ---- Score gauge ----
    {% if run and summary and summary.get('overall_score') is not none %}
    const seoScore = {{ summary.get('overall_score', 0) }};
    const seoColor = seoScore >= 80 ? '#198754' : seoScore >= 60 ? '#ffc107' : '#dc3545';
    if (typeof drawScoreGauge === 'function') {
        drawScoreGauge('seoScoreGauge', seoScore, seoColor);
    } else {
        // Fallback: draw with Chart.js doughnut if drawScoreGauge not available
        const ctx = document.getElementById('seoScoreGauge');
        if (ctx) {
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [seoScore, 100 - seoScore],
                        backgroundColor: [seoColor, '#e9ecef'],
                        borderWidth: 0,
                        circumference: 270,
                        rotation: 225,
                    }]
                },
                options: {
                    cutout: '78%',
                    responsive: false,
                    plugins: { legend: { display: false }, tooltip: { enabled: false } }
                }
            });
        }
    }
    {% endif %}

    // ---- Expand / Collapse all accordion sections ----
    const accordion = document.getElementById('seoAccordion');
    const expandBtn  = document.getElementById('expandAllBtn');
    const collapseBtn = document.getElementById('collapseAllBtn');

    if (expandBtn && accordion) {
        expandBtn.addEventListener('click', () => {
            accordion.querySelectorAll('.accordion-collapse').forEach(el => {
                const bsCollapse = bootstrap.Collapse.getOrCreateInstance(el, { toggle: false });
                bsCollapse.show();
            });
        });
    }

    if (collapseBtn && accordion) {
        collapseBtn.addEventListener('click', () => {
            accordion.querySelectorAll('.accordion-collapse').forEach(el => {
                const bsCollapse = bootstrap.Collapse.getOrCreateInstance(el, { toggle: false });
                bsCollapse.hide();
            });
        });
    }

});
</script>
{% endblock %}
